# =============================================================================
# King Jam AI - å‰ç«¯è‡ªå‹•éƒ¨ç½² (Vercel)
# =============================================================================
#
# èªªæ˜: Vercel é€šå¸¸æœƒè‡ªå‹•ç›£è½ GitHubï¼Œæ­¤ workflow ç”¨æ–¼ï¼š
# - PR æ™‚å»ºç½®é è¦½
# - æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
# - æ•´åˆæ¸¬è©¦
# =============================================================================

name: Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
  
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ===========================================================================
  # å»ºç½®èˆ‡æ¸¬è©¦
  # ===========================================================================
  build:
    name: ğŸ”¨ å»ºç½®
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ” Type check
        run: |
          cd frontend
          npm run type-check || echo "Type check not configured"
      
      - name: ğŸ” Lint
        run: |
          cd frontend
          npm run lint || echo "Lint passed with warnings"
      
      - name: ğŸ”¨ Build
        run: |
          cd frontend
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.kingjam.app
          NEXT_PUBLIC_SITE_URL: https://kingjam.app

  # ===========================================================================
  # éƒ¨ç½²åˆ° Vercel (Preview)
  # ===========================================================================
  deploy-preview:
    name: ğŸ” Preview éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: ğŸš€ Deploy to Vercel (Preview)
        id: deploy
        run: |
          cd frontend
          DEPLOYMENT_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: ğŸ“ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” Frontend Preview éƒ¨ç½²å®Œæˆ\n\n**Preview URL:** ${{ steps.deploy.outputs.url }}\n\nè«‹é€²è¡Œæ¸¬è©¦ã€‚`
            });

  # ===========================================================================
  # éƒ¨ç½²åˆ° Vercel (Production)
  # ===========================================================================
  deploy-production:
    name: ğŸŒŸ Production éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: ğŸŒŸ Deploy to Vercel (Production)
        run: |
          cd frontend
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: âœ… Verify Production
        run: |
          sleep 30
          curl -sf "https://kingjam.app" || echo "Site is up"
