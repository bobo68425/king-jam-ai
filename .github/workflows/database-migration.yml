# =============================================================================
# King Jam AI - è³‡æ–™åº«é·ç§» (æ‰‹å‹•è§¸ç™¼)
# =============================================================================
#
# ä½¿ç”¨æ–¹å¼:
# 1. å‰å¾€ GitHub Actions
# 2. é¸æ“‡ "Database Migration" workflow
# 3. é»æ“Š "Run workflow"
# 4. é¸æ“‡ç’°å¢ƒå’Œæ“ä½œ
# =============================================================================

name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç›®æ¨™ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'é·ç§»å‹•ä½œ'
        required: true
        default: 'upgrade'
        type: choice
        options:
          - upgrade        # å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬
          - downgrade      # å›æ»¾ä¸€å€‹ç‰ˆæœ¬
          - current        # é¡¯ç¤ºç•¶å‰ç‰ˆæœ¬
          - history        # é¡¯ç¤ºé·ç§»æ­·å²

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-east1

jobs:
  migrate:
    name: ğŸ—„ï¸ è³‡æ–™åº«é·ç§»
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: â˜ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install sqlalchemy alembic psycopg2-binary
      
      - name: â˜ï¸ Setup Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
      
      - name: ğŸ”— Start Cloud SQL Proxy
        run: |
          ./cloud_sql_proxy -instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:kingjam-db=tcp:5432 &
          sleep 5
      
      - name: ğŸ—„ï¸ Run Migration
        run: |
          cd backend
          
          export DATABASE_URL="postgresql://kingjam:${{ secrets.DB_PASSWORD }}@localhost:5432/kingjam_db"
          
          case "${{ inputs.action }}" in
            upgrade)
              echo "ğŸ“ˆ å‡ç´šè³‡æ–™åº«..."
              # æª¢æŸ¥æ˜¯å¦æœ‰å¤šå€‹ head
              HEADS=$(alembic heads 2>/dev/null | wc -l)
              if [ "$HEADS" -gt 1 ]; then
                echo "âš ï¸ åµæ¸¬åˆ°å¤šå€‹ Alembic headsï¼ŒåŸ·è¡Œç›´æ¥ SQL é·ç§»..."
                # ç›´æ¥åŸ·è¡Œ NewebPay æ¬„ä½é·ç§»
                python -c "
import os
from sqlalchemy import create_engine, text
engine = create_engine(os.environ['DATABASE_URL'])
with engine.connect() as conn:
    conn.execute(text('''
        DO \$\$ 
        BEGIN
            IF NOT EXISTS (
                SELECT 1 FROM information_schema.columns 
                WHERE table_name = 'orders' AND column_name = 'newebpay_merchant_order_no'
            ) THEN
                ALTER TABLE orders ADD COLUMN newebpay_merchant_order_no VARCHAR(30);
            END IF;
            
            IF NOT EXISTS (
                SELECT 1 FROM information_schema.columns 
                WHERE table_name = 'orders' AND column_name = 'newebpay_trade_no'
            ) THEN
                ALTER TABLE orders ADD COLUMN newebpay_trade_no VARCHAR(30);
            END IF;
        END \$\$;
    '''))
    conn.commit()
print('âœ… SQL é·ç§»å®Œæˆ')
"
              else
                alembic upgrade head
              fi
              ;;
            downgrade)
              echo "ğŸ“‰ å›æ»¾è³‡æ–™åº«ä¸€å€‹ç‰ˆæœ¬..."
              alembic downgrade -1
              ;;
            current)
              echo "ğŸ“ ç•¶å‰è³‡æ–™åº«ç‰ˆæœ¬:"
              alembic current
              ;;
            history)
              echo "ğŸ“œ é·ç§»æ­·å²:"
              alembic history --verbose
              ;;
          esac
      
      - name: âœ… Verify
        if: inputs.action == 'upgrade' || inputs.action == 'downgrade'
        run: |
          cd backend
          export DATABASE_URL="postgresql://kingjam:${{ secrets.DB_PASSWORD }}@localhost:5432/kingjam_db"
          echo "ğŸ“ ç•¶å‰ç‰ˆæœ¬:"
          alembic current
