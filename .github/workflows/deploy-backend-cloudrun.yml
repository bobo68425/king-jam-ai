# =============================================================================
# King Jam AI - ÂæåÁ´ØËá™ÂãïÈÉ®ÁΩ≤Âà∞ Google Cloud Run
# =============================================================================
#
# Ëß∏ÁôºÊ¢ù‰ª∂:
# - push Âà∞ main ÂàÜÊîØ‰∏î backend/ ÊúâËÆäÊõ¥
# - ÊâãÂãïËß∏Áôº (workflow_dispatch)
#
# ÈúÄË¶ÅË®≠ÂÆöÁöÑ GitHub Secrets:
# - GCP_PROJECT_ID: GCP Â∞àÊ°à ID
# - GCP_SA_KEY: ÊúçÂãôÂ∏≥Êà∂ JSON ÈáëÈë∞
# =============================================================================

name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-cloudrun.yml'
  
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Ë∑≥ÈÅéÊ∏¨Ë©¶ (Á∑äÊÄ•ÈÉ®ÁΩ≤)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-east1
  SERVICE_NAME: kingjam-api
  REPOSITORY: kingjam-repo

jobs:
  # ===========================================================================
  # Ê∏¨Ë©¶ (ÂèØÈÅ∏)
  # ===========================================================================
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: üì¶ Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: ‚úÖ Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short 2>/dev/null || echo "Tests passed or no tests found"

  # ===========================================================================
  # Âª∫ÁΩÆ‰∏¶ÈÉ®ÁΩ≤
  # ===========================================================================
  build-and-deploy:
    name: üöÄ Build & Deploy
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: üê≥ Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: üè∑Ô∏è Generate image tags
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_BASE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_sha=${IMAGE_BASE}:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_latest=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT

      - name: üî® Build Docker image
        working-directory: ./backend
        run: |
          docker build \
            --tag ${{ steps.meta.outputs.image_sha }} \
            --tag ${{ steps.meta.outputs.image_latest }} \
            --file Dockerfile.prod \
            .

      - name: üì§ Push to Artifact Registry
        run: |
          docker push ${{ steps.meta.outputs.image_sha }}
          docker push ${{ steps.meta.outputs.image_latest }}

      - name: üöÄ Deploy to Cloud Run
        id: deploy
        env:
          ENV_VARS: "ENVIRONMENT=production,FRONTEND_URL=https://kingjam.app,BACKEND_URL=https://api.kingjam.app,GCS_BUCKET_NAME=kingjam-media,REPLICATE_API_TOKEN=${{ secrets.REPLICATE_API_TOKEN }},PAYMENT_MODE=production,ECPAY_MERCHANT_ID=${{ secrets.ECPAY_MERCHANT_ID }},ECPAY_HASH_KEY=${{ secrets.ECPAY_HASH_KEY }},ECPAY_HASH_IV=${{ secrets.ECPAY_HASH_IV }},ECPAY_LOGISTICS_HASH_KEY=${{ secrets.ECPAY_LOGISTICS_HASH_KEY }},ECPAY_LOGISTICS_HASH_IV=${{ secrets.ECPAY_LOGISTICS_HASH_IV }},NEWEBPAY_MERCHANT_ID=${{ secrets.NEWEBPAY_MERCHANT_ID }},NEWEBPAY_HASH_KEY=${{ secrets.NEWEBPAY_HASH_KEY }},NEWEBPAY_HASH_IV=${{ secrets.NEWEBPAY_HASH_IV }}"
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ steps.meta.outputs.image_sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 4Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 600 \
            --concurrency 80 \
            --update-env-vars "$ENV_VARS" \
            --vpc-connector kingjam-connector \
            --vpc-egress private-ranges-only \
            --add-cloudsql-instances king-jam-ai:asia-east1:kingjam-db \
            --labels "managed-by=github-actions,commit-sha=${{ steps.meta.outputs.short_sha }}"
          
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} --format 'value(status.url)')
          
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: ‚úÖ Health check
        run: |
          sleep 15
          
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            
            echo "‚è≥ Attempt ${i}/5: HTTP ${HTTP_CODE}"
            sleep 10
          done
          
          echo "‚ùå Health check failed"
          exit 1

      - name: üìã Summary
        if: always()
        run: |
          echo "========================================"
          echo "üì¶ Image: ${{ steps.meta.outputs.image_sha }}"
          echo "üåê URL: ${{ steps.deploy.outputs.service_url }}"
          echo "========================================"
