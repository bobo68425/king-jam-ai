# =============================================================================
# King Jam AI - å‰ç«¯è‡ªå‹•éƒ¨ç½²åˆ° Google Cloud Run
# =============================================================================
#
# è§¸ç™¼æ¢ä»¶:
# - push åˆ° main åˆ†æ”¯ä¸” frontend/ æœ‰è®Šæ›´
# - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
#
# æµç¨‹:
# 1. Checkout ä»£ç¢¼
# 2. èªè­‰ Google Cloud
# 3. å»ºç½® Docker æ˜ åƒæª”
# 4. æ¨é€åˆ° Artifact Registry
# 5. éƒ¨ç½²åˆ° Cloud Run
# 6. å¥åº·æª¢æŸ¥é©—è­‰
#
# éœ€è¦è¨­å®šçš„ GitHub Secrets:
# - GCP_PROJECT_ID: GCP å°ˆæ¡ˆ ID
# - GCP_SA_KEY: æœå‹™å¸³æˆ¶ JSON é‡‘é‘° (éœ€æœ‰ Cloud Runã€Artifact Registry æ¬Šé™)
# =============================================================================

name: Deploy Frontend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend-cloudrun.yml'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# ç’°å¢ƒè®Šæ•¸
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-east1
  SERVICE_NAME: kingjam-frontend
  REPOSITORY: kingjam-repo
  
  # æ‡‰ç”¨ç¨‹å¼è¨­å®š
  NEXT_PUBLIC_API_URL: https://api.kingjam.app
  NEXT_PUBLIC_SITE_URL: https://kingjam.app

jobs:
  # ===========================================================================
  # å»ºç½®ä¸¦éƒ¨ç½²
  # ===========================================================================
  build-and-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest
    
    # è¨­å®šæ¬Šé™
    permissions:
      contents: read
      id-token: write
    
    steps:
      # -----------------------------------------
      # Step 1: Checkout ä»£ç¢¼
      # -----------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------
      # Step 2: èªè­‰ Google Cloud
      # -----------------------------------------
      - name: ğŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # -----------------------------------------
      # Step 3: è¨­å®š Google Cloud SDK
      # -----------------------------------------
      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # -----------------------------------------
      # Step 4: é…ç½® Docker èªè­‰
      # -----------------------------------------
      - name: ğŸ³ Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # -----------------------------------------
      # Step 5: å»ºç«‹æ˜ åƒæª”æ¨™ç±¤
      # -----------------------------------------
      - name: ğŸ·ï¸ Generate image tags
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_BASE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "image_base=${IMAGE_BASE}" >> $GITHUB_OUTPUT
          echo "image_sha=${IMAGE_BASE}:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_latest=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
          echo "image_timestamped=${IMAGE_BASE}:${TIMESTAMP}" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # Step 6: å»ºç½® Docker æ˜ åƒæª”
      # -----------------------------------------
      - name: ğŸ”¨ Build Docker image
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ Building Docker image..."
          echo "   Image: ${{ steps.meta.outputs.image_sha }}"
          
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }} \
            --build-arg NEXT_PUBLIC_SITE_URL=${{ env.NEXT_PUBLIC_SITE_URL }} \
            --tag ${{ steps.meta.outputs.image_sha }} \
            --tag ${{ steps.meta.outputs.image_latest }} \
            --tag ${{ steps.meta.outputs.image_timestamped }} \
            --file Dockerfile \
            .
          
          echo "âœ… Build completed!"
          
          # é¡¯ç¤ºæ˜ åƒæª”å¤§å°
          docker images ${{ steps.meta.outputs.image_base }} --format "table {{.Tag}}\t{{.Size}}"

      # -----------------------------------------
      # Step 7: æ¨é€æ˜ åƒæª”åˆ° Artifact Registry
      # -----------------------------------------
      - name: ğŸ“¤ Push to Artifact Registry
        run: |
          echo "ğŸ“¤ Pushing images to Artifact Registry..."
          
          docker push ${{ steps.meta.outputs.image_sha }}
          docker push ${{ steps.meta.outputs.image_latest }}
          docker push ${{ steps.meta.outputs.image_timestamped }}
          
          echo "âœ… Push completed!"

      # -----------------------------------------
      # Step 8: éƒ¨ç½²åˆ° Cloud Run
      # -----------------------------------------
      - name: ğŸš€ Deploy to Cloud Run
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ steps.meta.outputs.image_sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 60 \
            --concurrency 100 \
            --update-env-vars "NODE_ENV=production,NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }},NEXT_PUBLIC_SITE_URL=${{ env.NEXT_PUBLIC_SITE_URL }}" \
            --labels "managed-by=github-actions,commit-sha=${{ steps.meta.outputs.short_sha }}"
          
          # å–å¾—æœå‹™ URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Deployment completed!"
          echo "ğŸŒ Service URL: ${SERVICE_URL}"

      # -----------------------------------------
      # Step 9: å¥åº·æª¢æŸ¥
      # -----------------------------------------
      - name: âœ… Health check
        run: |
          echo "ğŸ” Running health check..."
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"
          
          # ç­‰å¾…æœå‹™ç©©å®š
          sleep 10
          
          # å˜—è©¦ 5 æ¬¡å¥åº·æª¢æŸ¥
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed! (HTTP ${HTTP_CODE})"
              exit 0
            fi
            
            echo "â³ Attempt ${i}/5: HTTP ${HTTP_CODE}, retrying in 10s..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      # -----------------------------------------
      # Step 10: éƒ¨ç½²æ‘˜è¦
      # -----------------------------------------
      - name: ğŸ“‹ Deployment summary
        if: always()
        run: |
          echo "========================================"
          echo "         Deployment Summary"
          echo "========================================"
          echo ""
          echo "ğŸ“¦ Image: ${{ steps.meta.outputs.image_sha }}"
          echo "ğŸŒ URL: ${{ steps.deploy.outputs.service_url }}"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo ""
          echo "========================================"

      # -----------------------------------------
      # Step 11: å¤±æ•—æ™‚é€šçŸ¥ (å¯é¸)
      # -----------------------------------------
      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs for more details."
          # é€™è£¡å¯ä»¥åŠ å…¥ Slack/Discord/Email é€šçŸ¥
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âŒ Frontend deployment failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
