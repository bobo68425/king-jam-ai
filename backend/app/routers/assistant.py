"""
æ™ºèƒ½åŠ©æ‰‹ API
ä½¿ç”¨ Google Gemini AI çµåˆç«™å…§çŸ¥è­˜åº«å›ç­”å•é¡Œ
"""

from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel, Field
from typing import Optional, List
from sqlalchemy.orm import Session
import os
import re

from app.database import get_db
from app.routers.auth import get_current_user_optional
from app.models import User

router = APIRouter(prefix="/assistant", tags=["assistant"])


class ChatRequest(BaseModel):
    message: str = Field(..., min_length=1, max_length=2000)
    session_id: Optional[str] = None


class ChatResponse(BaseModel):
    response: str
    session_id: Optional[str] = None
    suggestions: Optional[List[str]] = None


# ============================================================
# ç«™å…§çŸ¥è­˜åº« - æä¾›çµ¦ AI ä½œç‚ºä¸Šä¸‹æ–‡
# ============================================================

SITE_KNOWLEDGE = """
# King Jam AI å¹³å°çŸ¥è­˜åº«

## å¹³å°ç°¡ä»‹
King Jam AI æ˜¯ä¸€å€‹ AI é©…å‹•çš„æ™ºæ…§å…§å®¹å‰µä½œå¹³å°ï¼Œæä¾›ä¸€ç«™å¼çš„å…§å®¹å‰µä½œè§£æ±ºæ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
- AI æ–‡ç« ç”Ÿæˆ
- ç¤¾ç¾¤åœ–æ–‡è¨­è¨ˆ
- AI çŸ­å½±ç‰‡è£½ä½œ
- å¤šå¹³å°æ’ç¨‹ç™¼å¸ƒ

## ä¸»è¦åŠŸèƒ½

### 1. AI æ–‡ç« ç”Ÿæˆ
- æ”¯æ´éƒ¨è½æ ¼æ–‡ç« ã€ç”¢å“ä»‹ç´¹ã€æ–°èç¨¿ã€SEO æ–‡ç« ã€ç¤¾ç¾¤è²¼æ–‡
- å¯é¸æ“‡ä¸åŒé¢¨æ ¼å’Œèªæ°£
- æ”¯æ´å¤šç¨®èªè¨€
- æ¶ˆè€—é»æ•¸ï¼šç´„ 10-30 é»/ç¯‡

### 2. ç¤¾ç¾¤åœ–æ–‡è¨­è¨ˆ
- æ”¯æ´ Instagramã€Facebookã€LINEã€Twitter/X
- è‡ªå‹•ç”Ÿæˆæ–‡æ¡ˆå’Œåœ–ç‰‡å»ºè­°
- æä¾›å¤šç¨®æ¨¡æ¿
- æ¶ˆè€—é»æ•¸ï¼šç´„ 20-50 é»/å¼µ

### 3. AI çŸ­å½±ç‰‡ç”Ÿæˆ
- è‡ªå‹•é…éŸ³ï¼ˆå¤šç¨®èªéŸ³å¯é¸ï¼‰
- AI ç”Ÿæˆç•«é¢
- å­—å¹•è‡ªå‹•ç”Ÿæˆ
- èƒŒæ™¯éŸ³æ¨‚
- ç”Ÿæˆæ™‚é–“ï¼šç´„ 2-5 åˆ†é˜
- æ¶ˆè€—é»æ•¸ï¼šç´„ 100-300 é»/æ”¯

### 4. æ’ç¨‹ç™¼å¸ƒ
- æ”¯æ´ Facebook ç²‰çµ²å°ˆé ã€Instagram å•†æ¥­å¸³è™Ÿã€LINE å®˜æ–¹å¸³è™Ÿã€WordPress
- éœ€å…ˆåœ¨ã€Œç¤¾ç¾¤å¸³è™Ÿç®¡ç†ã€ä¸­ç¶å®šå¸³è™Ÿ

## é»æ•¸èˆ‡æ–¹æ¡ˆ

### é»æ•¸ç”¨é€”
- æ–‡ç« ç”Ÿæˆï¼šç´„ 10-30 é»/ç¯‡
- åœ–æ–‡è¨­è¨ˆï¼šç´„ 20-50 é»/å¼µ
- çŸ­å½±ç‰‡ï¼šç´„ 100-300 é»/æ”¯

### è³¼è²·æ–¹æ¡ˆ
- è¼•é‡åŒ…ï¼š100 é» - NT$99
- æ¨™æº–åŒ…ï¼š500 é» - NT$399
- å°ˆæ¥­åŒ…ï¼š1500 é» - NT$999
- ä¼æ¥­åŒ…ï¼š5000 é» - NT$2999

### æ–°ç”¨æˆ¶å„ªæƒ 
- è¨»å†Šå³è´ˆ 100 é»å…è²»è©¦ç”¨

## å¸³è™Ÿç›¸é—œ

### ç™»å…¥æ–¹å¼
- Email + å¯†ç¢¼
- Google å¸³è™Ÿå¿«é€Ÿç™»å…¥
- Facebook å¸³è™Ÿç™»å…¥

### å¿˜è¨˜å¯†ç¢¼
1. é»æ“Šç™»å…¥é çš„ã€Œå¿˜è¨˜å¯†ç¢¼ã€
2. è¼¸å…¥è¨»å†Šä¿¡ç®±
3. æ”¶å–é‡è¨­ä¿¡ä»¶
4. é»æ“Šé€£çµè¨­å®šæ–°å¯†ç¢¼

## é€€æ¬¾æ”¿ç­–
- è³¼è²·å¾Œ 7 å¤©å…§å¯ç”³è«‹
- é»æ•¸ä½¿ç”¨ä¸è¶…é 10%
- é¦–æ¬¡è³¼è²·å¯å…¨é¡é€€æ¬¾
- ç”³è«‹æ–¹å¼ï¼šç™¼é€éƒµä»¶è‡³ service@kingjam.app

## å®¢æœè³‡è¨Š
- Emailï¼šservice@kingjam.app
- å®¢æœæ™‚é–“ï¼šé€±ä¸€è‡³é€±äº” 09:00-18:00
- å›è¦†æ™‚é–“ï¼š24 å°æ™‚å…§

## å¸¸è¦‹å•é¡Œ

Q: ç”Ÿæˆçš„å…§å®¹å¯ä»¥å•†ç”¨å—ï¼Ÿ
A: æ˜¯çš„ï¼Œæ‰€æœ‰é€é King Jam AI ç”Ÿæˆçš„å…§å®¹ç‰ˆæ¬Šæ­¸æ‚¨æ‰€æœ‰ï¼Œå¯è‡ªç”±å•†æ¥­ä½¿ç”¨ã€‚

Q: æ”¯æ´å“ªäº›èªè¨€ï¼Ÿ
A: ä¸»è¦æ”¯æ´ç¹é«”ä¸­æ–‡ã€ç°¡é«”ä¸­æ–‡ã€è‹±æ–‡ï¼Œå…¶ä»–èªè¨€ä¹Ÿå¯å˜—è©¦ã€‚

Q: å¦‚ä½•ç¶å®šç¤¾ç¾¤å¸³è™Ÿï¼Ÿ
A: å‰å¾€ã€Œè¨­å®šã€>ã€Œç¤¾ç¾¤å¸³è™Ÿç®¡ç†ã€ï¼Œé»æ“Šå°æ‡‰å¹³å°çš„ã€Œç¶å®šã€æŒ‰éˆ•ï¼Œä¾ç…§æŒ‡ç¤ºå®Œæˆæˆæ¬Šã€‚

Q: é»æ•¸æœ‰æœŸé™å—ï¼Ÿ
A: è³¼è²·çš„é»æ•¸ç„¡ä½¿ç”¨æœŸé™ï¼Œå¯å®‰å¿ƒä½¿ç”¨ã€‚

Q: å¯ä»¥æ‰¹é‡ç”Ÿæˆå…§å®¹å—ï¼Ÿ
A: å¯ä»¥ï¼Œæ‚¨å¯ä»¥ä¸€æ¬¡ç”Ÿæˆå¤šç¯‡æ–‡ç« æˆ–å¤šå¼µåœ–æ–‡ï¼Œç³»çµ±æœƒä¾åºè™•ç†ã€‚
"""

# ============================================================
# AI å›æ‡‰ç”Ÿæˆ
# ============================================================

def get_ai_response(message: str, user: Optional[User] = None) -> str:
    """
    ä½¿ç”¨ Google Gemini AI ç”Ÿæˆå›æ‡‰
    """
    try:
        import google.generativeai as genai
        
        api_key = os.getenv("GOOGLE_API_KEY") or os.getenv("GEMINI_API_KEY")
        if not api_key:
            return get_fallback_response(message, user)
        
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-1.5-flash')
        
        # æ§‹å»ºç”¨æˆ¶ä¸Šä¸‹æ–‡
        user_context = ""
        if user:
            user_context = f"""
ç”¨æˆ¶è³‡è¨Šï¼š
- åç¨±ï¼š{user.name or 'æœªè¨­å®š'}
- é»æ•¸é¤˜é¡ï¼š{user.credits or 0} é»
- æ–¹æ¡ˆç­‰ç´šï¼š{user.subscription_tier or 'å…è²»'}
"""
        
        # æ§‹å»ºæç¤º
        prompt = f"""ä½ æ˜¯ King Jam AI çš„æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œåå«ã€Œå°å¹«æ‰‹ã€ã€‚è«‹æ ¹æ“šä»¥ä¸‹çŸ¥è­˜åº«å›ç­”ç”¨æˆ¶å•é¡Œã€‚

{SITE_KNOWLEDGE}

{user_context}

å›ç­”è¦å‰‡ï¼š
1. ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”
2. èªæ°£è¦ªåˆ‡å‹å–„ï¼Œå¯é©ç•¶ä½¿ç”¨ emoji
3. å›ç­”è¦ç°¡æ½”æ˜ç­ï¼Œé‡é»æ¸…æ™°
4. å¦‚æœå•é¡Œèˆ‡å¹³å°ç„¡é—œï¼Œç¦®è²Œåœ°å¼•å°ç”¨æˆ¶è©¢å•å¹³å°ç›¸é—œå•é¡Œ
5. å¦‚æœä¸ç¢ºå®šç­”æ¡ˆï¼Œå»ºè­°ç”¨æˆ¶è¯ç¹«å®¢æœ service@kingjam.app
6. ä¸è¦ç·¨é€ ä¸å­˜åœ¨çš„åŠŸèƒ½æˆ–åƒ¹æ ¼

ç”¨æˆ¶å•é¡Œï¼š{message}

è«‹å›ç­”ï¼š"""

        response = model.generate_content(prompt)
        return response.text.strip()
        
    except Exception as e:
        print(f"AI å›æ‡‰éŒ¯èª¤: {e}")
        return get_fallback_response(message, user)


def get_fallback_response(message: str, user: Optional[User] = None) -> str:
    """
    ç•¶ AI ä¸å¯ç”¨æ™‚çš„å‚™ç”¨å›æ‡‰ï¼ˆä½¿ç”¨é—œéµå­—åŒ¹é…ï¼‰
    """
    message_lower = message.lower()
    
    # å•å€™èª
    if re.search(r"^(å—¨|å“ˆå›‰|ä½ å¥½|hi|hello|hey)", message_lower):
        name = user.name if user and user.name else ""
        greeting = f"æ‚¨å¥½{name}ï¼" if name else "å—¨ï¼"
        return f"""{greeting}æˆ‘æ˜¯ King Jam AI æ™ºèƒ½åŠ©æ‰‹ ğŸ¤–

ä»Šå¤©æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©æ‚¨çš„å—ï¼Ÿ

æ‚¨å¯ä»¥è©¢å•ï¼š
- å¦‚ä½•ä½¿ç”¨å¹³å°åŠŸèƒ½
- é»æ•¸èˆ‡æ–¹æ¡ˆèªªæ˜
- å…§å®¹å‰µä½œæŠ€å·§
- æŠ€è¡“å•é¡Œæ’è§£"""

    # æ„Ÿè¬èª
    if re.search(r"(è¬è¬|æ„Ÿè¬|thanks|thank)", message_lower):
        return """ä¸å®¢æ°£ï¼å¾ˆé«˜èˆˆèƒ½å¹«åˆ°æ‚¨ ğŸ˜Š

å¦‚æœé‚„æœ‰å…¶ä»–å•é¡Œï¼Œéš¨æ™‚æ­¡è¿è©¢å•ï¼"""

    # æ–°æ‰‹å…¥é–€
    if re.search(r"(æ–°ç”¨æˆ¶|æ–°æ‰‹|é–‹å§‹|å…¥é–€|å¦‚ä½•ä½¿ç”¨)", message_lower):
        return """æ­¡è¿ä½¿ç”¨ King Jam AIï¼ğŸ‰

å¿«é€Ÿå…¥é–€æŒ‡å—ï¼š

1. **è¨»å†Š/ç™»å…¥** - ä½¿ç”¨ Email æˆ– Google å¸³è™Ÿ
2. **é ˜å–å…è²»é»æ•¸** - æ–°ç”¨æˆ¶ç²å¾— 100 é»è©¦ç”¨
3. **é¸æ“‡å‰µä½œé¡å‹** - æ–‡ç« ã€åœ–æ–‡æˆ–çŸ­å½±ç‰‡
4. **è¼¸å…¥ä¸»é¡Œ** - å‘Šè¨´ AI ä½ æƒ³å‰µä½œçš„å…§å®¹
5. **ä¸€éµç”Ÿæˆ** - AI å°‡ç‚ºä½ ç”Ÿæˆå°ˆæ¥­å…§å®¹

æœ‰ä»»ä½•å•é¡Œæ­¡è¿éš¨æ™‚è©¢å•ï¼"""

    # å½±ç‰‡ç›¸é—œ
    if re.search(r"(å½±ç‰‡|è¦–é »|video|çŸ­å½±éŸ³)", message_lower):
        return """AI çŸ­å½±ç‰‡ç”Ÿæˆä½¿ç”¨èªªæ˜ ğŸ“¹

**æ­¥é©Ÿï¼š**
1. é€²å…¥ã€ŒçŸ­å½±ç‰‡ç”Ÿæˆã€åŠŸèƒ½
2. è¼¸å…¥å½±ç‰‡ä¸»é¡Œæˆ–è…³æœ¬
3. é¸æ“‡é¢¨æ ¼å’Œæ™‚é•·
4. AI è‡ªå‹•ç”Ÿæˆå½±ç‰‡

**åŠŸèƒ½ç‰¹è‰²ï¼š**
- è‡ªå‹•é…éŸ³ï¼ˆå¤šç¨®èªéŸ³ï¼‰
- AI ç”Ÿæˆç•«é¢
- å­—å¹•è‡ªå‹•ç”Ÿæˆ
- èƒŒæ™¯éŸ³æ¨‚

â±ï¸ ç”Ÿæˆæ™‚é–“ï¼šç´„ 2-5 åˆ†é˜
ğŸ’° æ¶ˆè€—é»æ•¸ï¼šç´„ 100-300 é»/æ”¯"""

    # æ–‡ç« ç›¸é—œ
    if re.search(r"(æ–‡ç« |éƒ¨è½æ ¼|blog|å¯«ä½œ)", message_lower):
        return """AI æ–‡ç« ç”Ÿæˆä½¿ç”¨èªªæ˜ âœï¸

**æ­¥é©Ÿï¼š**
1. é¸æ“‡ã€Œæ–‡ç« ç”Ÿæˆã€åŠŸèƒ½
2. è¼¸å…¥æ–‡ç« ä¸»é¡Œæˆ–é—œéµå­—
3. é¸æ“‡æ–‡ç« é¡å‹å’Œé¢¨æ ¼
4. é»æ“Šç”Ÿæˆ

**æ”¯æ´é¡å‹ï¼š**
- éƒ¨è½æ ¼æ–‡ç« 
- ç”¢å“ä»‹ç´¹
- æ–°èç¨¿
- SEO å„ªåŒ–æ–‡ç« 
- ç¤¾ç¾¤è²¼æ–‡

ğŸ’° æ¶ˆè€—é»æ•¸ï¼šç´„ 10-30 é»/ç¯‡"""

    # é»æ•¸ç›¸é—œ
    if re.search(r"(é»æ•¸|åƒ¹æ ¼|æ–¹æ¡ˆ|è²»ç”¨|è³¼è²·)", message_lower):
        return """é»æ•¸èˆ‡æ–¹æ¡ˆèªªæ˜ ğŸ’°

**é»æ•¸ç”¨é€”ï¼š**
- æ–‡ç« ç”Ÿæˆï¼šç´„ 10-30 é»/ç¯‡
- åœ–æ–‡è¨­è¨ˆï¼šç´„ 20-50 é»/å¼µ
- çŸ­å½±ç‰‡ï¼šç´„ 100-300 é»/æ”¯

**è³¼è²·æ–¹æ¡ˆï¼š**
- è¼•é‡åŒ…ï¼š100 é» - NT$99
- æ¨™æº–åŒ…ï¼š500 é» - NT$399
- å°ˆæ¥­åŒ…ï¼š1500 é» - NT$999
- ä¼æ¥­åŒ…ï¼š5000 é» - NT$2999

ğŸ æ–°ç”¨æˆ¶è¨»å†Šå³è´ˆ 100 é»è©¦ç”¨ï¼"""

    # ç”¨æˆ¶é¤˜é¡æŸ¥è©¢
    if user and re.search(r"(æˆ‘çš„|æŸ¥è©¢|é¤˜é¡|å‰©é¤˜)", message_lower):
        return f"""æ‚¨çš„å¸³è™Ÿç‹€æ…‹ ğŸ“Š

- **å¯ç”¨é»æ•¸**ï¼š{user.credits or 0} é»
- **æ–¹æ¡ˆç­‰ç´š**ï¼š{user.subscription_tier or 'å…è²»'}

å¦‚éœ€è³¼è²·æ›´å¤šé»æ•¸ï¼Œè«‹å‰å¾€ã€Œåƒ¹æ ¼æ–¹æ¡ˆã€é é¢ï¼"""

    # å®¢æœè¯ç¹«
    if re.search(r"(è¯ç¹«|å®¢æœ|å•é¡Œ|å¹«åŠ©)", message_lower):
        return """å®¢æœè¯ç¹«æ–¹å¼ ğŸ“§

- **Email**ï¼šservice@kingjam.app
- **å®¢æœæ™‚é–“**ï¼šé€±ä¸€è‡³é€±äº” 09:00-18:00

æˆ‘å€‘æœƒåœ¨ 24 å°æ™‚å…§å›è¦†æ‚¨çš„éƒµä»¶ï¼"""

    # é è¨­å›æ‡‰
    return """æ„Ÿè¬æ‚¨çš„æå•ï¼æˆ‘æ˜¯ King Jam AI æ™ºèƒ½åŠ©æ‰‹ ğŸ¤–

æˆ‘å¯ä»¥å¹«åŠ©æ‚¨ï¼š
- äº†è§£å¹³å°åŠŸèƒ½èˆ‡ä½¿ç”¨æ–¹å¼
- è§£ç­”é»æ•¸èˆ‡æ–¹æ¡ˆç›¸é—œå•é¡Œ
- æä¾›å…§å®¹å‰µä½œå»ºè­°
- å”åŠ©æ’è§£ä½¿ç”¨å•é¡Œ

è«‹å•æ‚¨æƒ³äº†è§£ä»€éº¼å‘¢ï¼Ÿ"""


# ============================================================
# API ç«¯é»
# ============================================================

@router.post("/chat", response_model=ChatResponse)
async def chat(
    request: ChatRequest,
    db: Session = Depends(get_db),
    current_user: Optional[User] = Depends(get_current_user_optional)
):
    """
    æ™ºèƒ½åŠ©æ‰‹å°è©± API
    """
    try:
        response = get_ai_response(request.message, current_user)
        
        # ç”Ÿæˆå»ºè­°å•é¡Œ
        suggestions = []
        msg_lower = request.message.lower()
        if "é»æ•¸" not in msg_lower and "æ–¹æ¡ˆ" not in msg_lower:
            suggestions.append("é»æ•¸å¦‚ä½•è³¼è²·ï¼Ÿ")
        if "å½±ç‰‡" not in msg_lower:
            suggestions.append("å¦‚ä½•ç”Ÿæˆå½±ç‰‡ï¼Ÿ")
        if "æ’ç¨‹" not in msg_lower:
            suggestions.append("å¦‚ä½•æ’ç¨‹ç™¼å¸ƒï¼Ÿ")
        
        return ChatResponse(
            response=response,
            session_id=request.session_id,
            suggestions=suggestions[:3] if suggestions else None
        )
    except Exception as e:
        print(f"Chat API éŒ¯èª¤: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/suggestions")
async def get_suggestions():
    """ç²å–å¸¸è¦‹å•é¡Œå»ºè­°"""
    return {
        "suggestions": [
            "å¦‚ä½•é–‹å§‹ä½¿ç”¨ King Jam AIï¼Ÿ",
            "é»æ•¸å¦‚ä½•è¨ˆç®—ï¼Ÿæœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿ",
            "å¦‚ä½•ç”ŸæˆçŸ­å½±ç‰‡ï¼Ÿ",
            "å¦‚ä½•ä½¿ç”¨æ’ç¨‹ç™¼å¸ƒåŠŸèƒ½ï¼Ÿ",
            "å¦‚ä½•ç¶å®šç¤¾ç¾¤å¸³è™Ÿï¼Ÿ",
        ]
    }


@router.get("/faq")
async def get_faq():
    """ç²å–å¸¸è¦‹å•é¡Œåˆ—è¡¨"""
    return {
        "faq": [
            {
                "question": "ä»€éº¼æ˜¯ King Jam AIï¼Ÿ",
                "answer": "King Jam AI æ˜¯ä¸€å€‹ AI é©…å‹•çš„æ™ºæ…§å…§å®¹å‰µä½œå¹³å°ï¼Œå¯ä»¥å¹«åŠ©æ‚¨å¿«é€Ÿç”Ÿæˆæ–‡ç« ã€ç¤¾ç¾¤åœ–æ–‡å’ŒçŸ­å½±ç‰‡ã€‚"
            },
            {
                "question": "æ–°ç”¨æˆ¶æœ‰å…è²»è©¦ç”¨å—ï¼Ÿ",
                "answer": "æœ‰çš„ï¼æ–°ç”¨æˆ¶è¨»å†Šå³å¯ç²å¾— 100 é»å…è²»è©¦ç”¨é»æ•¸ã€‚"
            },
            {
                "question": "æ”¯æ´å“ªäº›ç¤¾ç¾¤å¹³å°ï¼Ÿ",
                "answer": "ç›®å‰æ”¯æ´ Facebookã€Instagramã€LINE å®˜æ–¹å¸³è™Ÿå’Œ WordPress çš„æ’ç¨‹ç™¼å¸ƒåŠŸèƒ½ã€‚"
            },
            {
                "question": "ç”Ÿæˆçš„å…§å®¹å¯ä»¥å•†ç”¨å—ï¼Ÿ",
                "answer": "æ˜¯çš„ï¼Œæ‰€æœ‰é€é King Jam AI ç”Ÿæˆçš„å…§å®¹ç‰ˆæ¬Šæ­¸æ‚¨æ‰€æœ‰ï¼Œå¯è‡ªç”±å•†æ¥­ä½¿ç”¨ã€‚"
            },
            {
                "question": "å¦‚ä½•è¯ç¹«å®¢æœï¼Ÿ",
                "answer": "æ‚¨å¯ä»¥ç™¼é€éƒµä»¶è‡³ service@kingjam.appï¼Œæˆ‘å€‘æœƒåœ¨ 24 å°æ™‚å…§å›è¦†ã€‚"
            }
        ]
    }
