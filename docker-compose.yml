# ============================================================
# å…±ç”¨ç’°å¢ƒè®Šæ•¸
# ============================================================
x-backend-env: &backend-env
  DATABASE_URL: postgresql://kingjam:kingjam_pass@db:5432/kingjam_db
  REDIS_URL: redis://redis:6379/0
  CELERY_BROKER_URL: redis://redis:6379/0
  CELERY_RESULT_BACKEND: redis://redis:6379/0
  SECRET_KEY: dev_secret_key_change_this
  # Google AI / OAuth (GA4)
  GOOGLE_CLIENT_ID: 563981454510-5aht48hb5i0nhb8fk3vjfin0min5ovm4.apps.googleusercontent.com
  GOOGLE_CLIENT_SECRET: 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
  GOOGLE_REDIRECT_URI: http://localhost:8000/oauth/google/callback
  GOOGLE_GEMINI_KEY: AIzaSyBh4uNnnoRcGXE7N5WmCMG9cyBQisnJEZw
  # Replicate API (Kling AI)
  REPLICATE_API_TOKEN: r8_OwpJaEdZWROXq6mu4lD8pJ0KmOh4J9X3fd1EU
  # ============================================================
  # å‘Šè­¦é€šçŸ¥é…ç½®ï¼ˆå¯é¸ï¼Œè¨­å®šå¾Œè‡ªå‹•å•Ÿç”¨ï¼‰
  # ============================================================
  # Slack Webhook URLï¼ˆå»ºè­°è¨­å®šï¼‰
  SLACK_WEBHOOK_URL: ""
  # å‘Šè­¦ Emailï¼ˆå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”ï¼‰
  ALERT_EMAIL: ""
  # Line Notify Token
  LINE_NOTIFY_TOKEN: ""
  # Vertex AI / Veo è¨­å®š
  GOOGLE_CLOUD_PROJECT: gen-lang-client-0390714167
  GOOGLE_CLOUD_LOCATION: us-central1
  GOOGLE_APPLICATION_CREDENTIALS: /app/secrets/google-credentials.json
  # é›²ç«¯å„²å­˜ (Cloudflare R2)
  CLOUD_STORAGE_PROVIDER: r2
  R2_ENDPOINT_URL: https://0ad0f476c65e7b6c58fd6016d577b6f6.r2.cloudflarestorage.com
  R2_ACCESS_KEY_ID: 2a1e21b4a2ff9aaa612e3c01da18a8e6
  R2_SECRET_ACCESS_KEY: a32081dfc5b00f2d082dc3e6e6284e5744ec771054833ba377b301b14ce7644d
  R2_BUCKET_NAME: kingjam-assets
  R2_PUBLIC_URL: https://pub-dd448be937ca4aaab1aacd75dcb601b4.r2.dev
  # ============================================================
  # ç¤¾ç¾¤å¹³å° OAuth è¨­å®š
  # ============================================================
  # Meta (Instagram/Facebook/Threads) - éœ€åœ¨ Meta Developer Console å‰µå»ºæ‡‰ç”¨
  META_APP_ID: your_meta_app_id
  META_APP_SECRET: your_meta_app_secret
  META_REDIRECT_URI: http://localhost:8000/oauth/meta/callback
  # TikTok - éœ€åœ¨ TikTok for Developers å‰µå»ºæ‡‰ç”¨
  TIKTOK_CLIENT_KEY: your_tiktok_client_key
  TIKTOK_CLIENT_SECRET: your_tiktok_client_secret
  TIKTOK_REDIRECT_URI: http://localhost:8000/oauth/tiktok/callback
  # LinkedIn - éœ€åœ¨ LinkedIn Developer Console å‰µå»ºæ‡‰ç”¨
  LINKEDIN_CLIENT_ID: your_linkedin_client_id
  LINKEDIN_CLIENT_SECRET: your_linkedin_client_secret
  LINKEDIN_REDIRECT_URI: http://localhost:8000/oauth/linkedin/callback
  # YouTube - ä½¿ç”¨ Google Cloud Console (èˆ‡ GOOGLE_CLIENT å…±ç”¨)
  YOUTUBE_REDIRECT_URI: http://localhost:8000/oauth/youtube/callback
  # LINE - éœ€åœ¨ LINE Developers Console å‰µå»º Channel
  LINE_CHANNEL_ID: your_line_channel_id
  LINE_CHANNEL_SECRET: your_line_channel_secret
  LINE_REDIRECT_URI: http://localhost:8000/oauth/line/callback
  LINE_CHANNEL_ACCESS_TOKEN: your_line_channel_access_token
  # éƒµä»¶æœå‹™ï¼ˆé–‹ç™¼æ¨¡å¼ä½¿ç”¨ consoleï¼‰
  EMAIL_PROVIDER: console
  # PicWish å»èƒŒ API
  PICWISH_API_KEY: wx65g7jrbsla2frr5

services:
  # ============================================================
  # å¾Œç«¯ API
  # ============================================================
  backend:
    build: ./backend
    container_name: kingjam_backend
    volumes:
      - ./backend:/app  # Hot Reload
      - ./secrets:/app/secrets:ro  # Google Cloud é‡‘é‘°
    ports:
      - "8000:8000"
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis
    networks:
      - kingjam_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # Celery Worker - é«˜å„ªå…ˆç´šä½‡åˆ—
  # è™•ç†ï¼šé©—è­‰ç¢¼ç™¼é€ã€å³æ™‚é€šçŸ¥ã€ç·Šæ€¥ Token åˆ·æ–°ã€å¥åº·æª¢æŸ¥
  # ============================================================
  celery-worker-high:
    build: ./backend
    container_name: kingjam_celery_high
    command: celery -A app.celery_app worker -Q queue_high -c 2 -l info --hostname=worker-high@%h
    volumes:
      - ./backend:/app
      - ./secrets:/app/secrets:ro
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis
    networks:
      - kingjam_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "/app/scripts/celery_healthcheck.py", "worker-high"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  # ============================================================
  # Celery Worker - é è¨­ä½‡åˆ—
  # è™•ç†ï¼šç¤¾ç¾¤ç™¼å¸ƒã€æ’ç¨‹ä»»å‹™ã€Token æ‰¹æ¬¡åˆ·æ–°
  # ============================================================
  celery-worker-default:
    build: ./backend
    container_name: kingjam_celery_default
    command: celery -A app.celery_app worker -Q queue_default -c 4 -l info --hostname=worker-default@%h
    volumes:
      - ./backend:/app
      - ./secrets:/app/secrets:ro
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis
    networks:
      - kingjam_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "/app/scripts/celery_healthcheck.py", "worker-default"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  # ============================================================
  # Celery Worker - å½±ç‰‡ä½‡åˆ—ï¼ˆä¸»ç¯€é»ï¼‰
  # è™•ç†ï¼šVeo/Kling å½±ç‰‡æ¸²æŸ“ï¼ˆè€—æ™‚ä»»å‹™ï¼Œç¨ç«‹éš”é›¢ï¼‰
  # 
  # å½ˆæ€§åŒ–æ¶æ§‹ï¼š
  # - ä½¿ç”¨ç¨ç«‹ Redis (redis-video) éš”é›¢ï¼Œé¿å…å½±éŸ¿é©—è­‰ç¢¼/ç™»å…¥
  # - æ”¯æ´æ°´å¹³æ“´å±•ï¼šdocker-compose up --scale celery-worker-video=N
  # - è‡ªå‹•æ“´å±•è…³æœ¬ï¼šscripts/video_autoscaler.py
  # 
  # OOM é é˜²æªæ–½ï¼š
  # - ä¸¦ç™¼æ•¸é™åˆ¶ç‚º 1ï¼ˆå–®ä¸€ä»»å‹™åŸ·è¡Œï¼‰
  # - æ¯è™•ç† 10 å€‹ä»»å‹™å¾Œè‡ªå‹•é‡å•Ÿï¼ˆé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼ï¼‰
  # ============================================================
  celery-worker-video:
    build: ./backend
    # ç§»é™¤å›ºå®š container_name ä»¥æ”¯æŒæ“´å±•
    # container_name: kingjam_celery_video
    command: >
      celery -A app.celery_app worker 
      -Q queue_video 
      -c 1 
      -l info 
      --hostname=worker-video-${HOSTNAME:-1}@%h
      --max-tasks-per-child=10
      --prefetch-multiplier=1
    volumes:
      - ./backend:/app
      - ./secrets:/app/secrets:ro
      - ./backend/static/videos:/app/static/videos  # å½±ç‰‡è¼¸å‡ºç›®éŒ„
      - ./backend/static/thumbnails:/app/static/thumbnails  # ç¸®åœ–ç›®éŒ„
    environment:
      <<: *backend-env
      # ğŸ”‘ å½±ç‰‡ä»»å‹™ä½¿ç”¨ç¨ç«‹ Redisï¼ˆéš”é›¢ï¼‰
      VIDEO_REDIS_URL: redis://redis-video:6379/0
      VIDEO_BROKER_URL: redis://redis-video:6379/0
      VIDEO_RESULT_BACKEND: redis://redis-video:6379/1
      # OOM ä¿è­·ç›¸é—œç’°å¢ƒè®Šæ•¸
      MALLOC_ARENA_MAX: 2  # æ¸›å°‘ glibc è¨˜æ†¶é«”ç¢ç‰‡
      PYTHONMALLOC: malloc
      # Worker æ¨™è­˜ï¼ˆç”¨æ–¼ç›£æ§ï¼‰
      WORKER_TYPE: video
    depends_on:
      - db
      - redis
      - redis-video
    networks:
      - kingjam_net
    restart: unless-stopped
    # å½±ç‰‡æ¸²æŸ“è³‡æºé™åˆ¶ï¼ˆOOM é é˜²ï¼‰
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G
          cpus: '0.5'
      # ğŸ”‘ Docker Swarm è‡ªå‹•æ“´å±•é…ç½®ï¼ˆå¯é¸ï¼‰
      # replicas: 1
      # update_config:
      #   parallelism: 1
      #   delay: 10s
      # restart_policy:
      #   condition: on-failure
    healthcheck:
      test: ["CMD", "python", "/app/scripts/celery_healthcheck.py", "worker-video"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s

  # ============================================================
  # Celery Beat - æ’ç¨‹ä»»å‹™æƒæå™¨
  # å®šæ™‚è§¸ç™¼ï¼šæƒæå¾…ç™¼å¸ƒæ’ç¨‹ã€Token éæœŸæª¢æŸ¥ã€æ—¥èªŒæ¸…ç†
  # ============================================================
  celery-beat:
    build: ./backend
    container_name: kingjam_celery_beat
    command: celery -A app.celery_app beat -l info --scheduler celery.beat:PersistentScheduler --schedule=/app/celerybeat-schedule
    volumes:
      - ./backend:/app
      - ./secrets:/app/secrets:ro
      - celery-beat-data:/app  # æŒä¹…åŒ– schedule è³‡æ–™
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis
    networks:
      - kingjam_net
    restart: unless-stopped

  # ============================================================
  # Flower - Celery ç›£æ§é¢æ¿ï¼ˆå¯é¸ï¼‰
  # ============================================================
  flower:
    build: ./backend
    container_name: kingjam_flower
    command: celery -A app.celery_app flower --port=5555 --broker=redis://redis:6379/0
    ports:
      - "5555:5555"
    environment:
      <<: *backend-env
      FLOWER_BASIC_AUTH: admin:kingjam123  # è¨­å®šç™»å…¥å¯†ç¢¼
    depends_on:
      - redis
      - celery-worker-default
    networks:
      - kingjam_net
    restart: unless-stopped

  # ============================================================
  # è³‡æ–™åº«
  # ============================================================
  db:
    image: postgres:15-alpine
    container_name: kingjam_db
    restart: always
    environment:
      - POSTGRES_USER=kingjam
      - POSTGRES_PASSWORD=kingjam_pass
      - POSTGRES_DB=kingjam_db
    ports:
      - "5432:5432"
    volumes:
      - ./.docker_data/postgres:/var/lib/postgresql/data
    networks:
      - kingjam_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kingjam -d kingjam_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # Redis - ä¸»è¦å¿«å– & è¨Šæ¯ä½‡åˆ—
  # ç”¨é€”ï¼šé©—è­‰ç¢¼ã€Token å¿«å–ã€ä¸€èˆ¬ä»»å‹™ä½‡åˆ—
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: kingjam_redis
    ports:
      - "6379:6379"
    volumes:
      - ./.docker_data/redis:/data
    networks:
      - kingjam_net
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # Redis Video - å½±ç‰‡ä»»å‹™å°ˆç”¨ï¼ˆéš”é›¢é¿å…å½±éŸ¿æ ¸å¿ƒæœå‹™ï¼‰
  # ç”¨é€”ï¼šå½±ç‰‡æ¸²æŸ“ä½‡åˆ—ã€å½±ç‰‡ä»»å‹™çµæœ
  # ============================================================
  redis-video:
    image: redis:7-alpine
    container_name: kingjam_redis_video
    ports:
      - "6380:6379"
    volumes:
      - ./.docker_data/redis-video:/data
    networks:
      - kingjam_net
    command: redis-server --appendonly yes --maxmemory 1gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  kingjam_net:
    driver: bridge

volumes:
  celery-beat-data:
