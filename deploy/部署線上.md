# King Jam AI 部署線上

## 方式一：GitHub Actions 自動部署（推薦）

程式推送到 `main` 後，會依變更路徑自動觸發：

| 變更路徑 | 觸發的 Workflow |
|----------|-----------------|
| `backend/**` | Deploy Backend to Cloud Run |
| `frontend/**` | Deploy Frontend to Cloud Run |

### 步驟

1. **確認 GitHub Secrets 已設定**（Settings → Secrets and variables → Actions）  
   至少需要：`GCP_PROJECT_ID`、`GCP_SA_KEY`，後端還需金流、Twilio 等（見 workflow 內 `ENV_VARS`）。

2. **提交並推送到 main**
   ```bash
   git add .
   git commit -m "feat: 訂閱年繳方案與部署設定"
   git push origin main
   ```

3. **到 GitHub Actions 查看執行結果**  
   https://github.com/你的帳號/king-jam-ai/actions

4. **執行資料庫遷移**（有改 DB 時）  
   - 同上頁面，選擇 **「Database Migration」**
   - 點 **Run workflow**
   - 目標環境選 **production**，動作選 **upgrade** → Run  
   - 需已設定 Secret：`DB_PASSWORD`（Cloud SQL 資料庫密碼）

---

## 方式二：手動觸發 Workflow（不推 code 也可重跑部署）

1. 打開 **Actions** → 選擇 **Deploy Backend to Cloud Run** 或 **Deploy Frontend to Cloud Run**
2. 點 **Run workflow** → 選分支 **main** → Run workflow
3. 若要一併跑資料庫遷移：再跑 **Database Migration**（同上，production + upgrade）

---

## 方式三：本機用腳本部署（需 gcloud + Docker）

```bash
# 設定專案
export GCP_PROJECT_ID=你的專案ID
gcloud auth login
gcloud config set project $GCP_PROJECT_ID

# 後端
cd deploy
chmod +x *.sh
./deploy-backend.sh

# 前端（同上目錄）
./deploy-frontend.sh
```

資料庫遷移需能連到 Cloud SQL（例如用 Cloud SQL Proxy 或 run-migrations.sh）。

---

## 部署後檢查

- **後端**：https://api.kingjam.app/health 應回傳 200
- **前端**：https://kingjam.app 可正常開啟
- **訂閱年繳**：到「定價」→ 訂閱方案 → 切換「年繳」確認價格與折扣顯示

---

## 常見問題

- **Backend workflow 失敗**：檢查 Secrets 是否齊全（含 ECPAY_*、TWILIO_* 等）。
- **DB 遷移失敗**：確認 `DB_PASSWORD` 正確，且 Cloud SQL 可從 GitHub Actions 連線（需 VPC/Proxy 或允許來源 IP）。
- **多個 Alembic heads**：目前 workflow 在偵測到多個 head 時會改跑內建 SQL（含訂閱年繳欄位），無需手動合併 head。
