# 部署失敗排查

## 一、先確認失敗位置

到 [GitHub Actions](https://github.com/bobo68425/king-jam-ai/actions) 點進失敗的那次 run，看是**哪一個 Step 紅掉**：

| Step | 可能原因 | 處理方式 |
|------|----------|----------|
| **Authenticate to Google Cloud** | `GCP_SA_KEY` 未設或 JSON 無效 | Repo → Settings → Secrets → 確認有 `GCP_PROJECT_ID`、`GCP_SA_KEY`，且金鑰是完整 JSON |
| **Set up Cloud SDK** | `GCP_PROJECT_ID` 為空 | 在 Secrets 設定 `GCP_PROJECT_ID`（與 GCP Console 專案 ID 一致） |
| **Run tests** (後端) | 無 `tests/` 或 pytest 失敗 | 已改為無 `tests/` 時跳過；若有目錄仍失敗，看 Actions 裡 pytest 錯誤訊息 |
| **Build Docker image** | 建置錯誤（依賴、語法、Next 建置失敗等） | 看該 step 的 log：前端多為 `npm run build` 失敗，後端多為 `Dockerfile`/依賴問題 |
| **Push to Artifact Registry** | 沒權限或 repo 不存在 | GCP：Artifact Registry 建立 `kingjam-repo`，且 SA 具 `Artifact Registry Writer` |
| **Deploy to Cloud Run** | 權限、VPC、Cloud SQL 名稱、env 過長等 | 見下方「後端 Deploy 失敗」 |
| **Health check** | 服務未啟動或逾時 | 見下方「健康檢查失敗」 |

---

## 二、後端 Deploy 失敗

### 1. Cloud SQL 連線名稱

Workflow 使用：

- 專案：`${{ secrets.GCP_PROJECT_ID }}`
- 連線名稱：`${{ PROJECT_ID }}:asia-east1:kingjam-db`

請在 GCP Console → **SQL** 確認：

- 執行個體名稱是 **kingjam-db**
- 區域是 **asia-east1**
- 所屬專案與 Secrets 的 `GCP_PROJECT_ID` 相同  

若執行個體名稱或區域不同，請改 workflow 裡 `--add-cloudsql-instances` 的連線名稱。

### 2. VPC Connector

指令中有 `--vpc-connector kingjam-connector`。請在 GCP → **VPC 網路** → **Serverless VPC 存取** 確認有名為 **kingjam-connector** 的 connector，且區域為 **asia-east1**。

### 3. 服務帳戶權限

用來部署的服務帳戶（`GCP_SA_KEY` 對應的 SA）至少需要：

- Cloud Run Admin
- Service Account User
- Artifact Registry Writer（或包含寫入的權限）
- 若用 Secret Manager：Secret Manager Secret Accessor

### 4. 環境變數過長或含特殊字元

後端一次傳很多 `--update-env-vars`。若某個 Secret 含 `,` 或 `=`，可能切錯導致 deploy 或執行錯誤。可改為用 **Secret Manager** 掛進 Cloud Run，或把有問題的變數從 ENV_VARS 拿掉，改在 GCP Console 手動設。

---

## 三、前端 Deploy 失敗

### 1. Docker 建置（npm run build）

- 看 **Build Docker image** 的 log，找到第一次報錯的那一行。
- 常見：記憶體不足（可改 workflow 的 `runs-on` 或建置方式）、依賴安裝失敗、TypeScript/ESLint 錯誤（若之後關掉 `ignoreDuringBuilds` / `ignoreBuildErrors`）。

### 2. standalone 輸出

Dockerfile 會複製 `.next/standalone`。請確認 `frontend/next.config.ts` 有：

```ts
output: "standalone",
```

沒有這行會在建置階段就失敗。

---

## 四、健康檢查失敗

Deploy 成功但 **Health check** step 紅掉：

- **後端**：約 15s 後對 `{SERVICE_URL}/health` 連打 5 次，每次間隔 10s。若 Cold Start 超過約 65s，或服務起不來，會失敗。
- **前端**：約 10s 後對首頁連打 5 次。

可先暫時放寬：在 workflow 裡把健康檢查改為 `continue-on-error: true`，讓 deploy 仍標為成功，再從 GCP Cloud Run 日誌看容器是否真的有起來、是否有 200。

---

## 五、快速檢查清單

- [ ] Secrets 有 `GCP_PROJECT_ID`、`GCP_SA_KEY`
- [ ] `GCP_PROJECT_ID` 與 GCP 專案 ID 完全一致
- [ ] GCP 有 Artifact Registry repo：`kingjam-repo`（區域 asia-east1）
- [ ] GCP 有 Cloud Run、VPC Connector、Cloud SQL（名稱/區域與 workflow 一致）
- [ ] 服務帳戶具備上述權限
- [ ] 後端若有缺的 Secret（金流、Twilio 等），可先設空值或假值讓 deploy 通過，再在 GCP Console 改回正確值

---

## 六、只改前端或只改後端時未觸發

- **Deploy Frontend** 只會在 **push 到 main** 且變更到 `frontend/**` 或該 workflow 檔時觸發。
- **Deploy Backend** 只會在變更到 `backend/**` 或該 workflow 檔時觸發。

若只改了別的路徑，不會跑對應的 deploy。可到 Actions 手動 **Run workflow** 選擇對應的 workflow 再跑一次。
